services:
  api:
    build:
      context: ../..
      dockerfile: docker/images/api/production.Dockerfile
    image: portfolio-api:production
    container_name: portfolio-api-prod
    init: true
    restart: unless-stopped
    environment:
      NODE_ENV: production
      API_GATEWAY_CONTENT_PROVIDER: ${API_GATEWAY_CONTENT_PROVIDER:-sanity}
      API_PORT: "5001"
      PORT: "5001"
      API_GATEWAY_CORS_ORIGINS: ${API_GATEWAY_CORS_ORIGINS:-}
      SANITY_PROJECT_ID: ${SANITY_PROJECT_ID:-}
      SANITY_DATASET: ${SANITY_DATASET:-}
      SANITY_API_VERSION: ${SANITY_API_VERSION:-}
      SANITY_API_READ_TOKEN: ${SANITY_API_READ_TOKEN:-}
      SANITY_USE_CDN: ${SANITY_USE_CDN:-true}
      SANITY_REQUEST_TIMEOUT_MS: ${SANITY_REQUEST_TIMEOUT_MS:-}
      SANITY_REQUEST_MAX_RETRIES: ${SANITY_REQUEST_MAX_RETRIES:-}
      SANITY_REQUEST_RETRY_DELAY_MS: ${SANITY_REQUEST_RETRY_DELAY_MS:-}
    ports:
      - "${PROD_API_PORT:-5001}:5001"
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          node -e "fetch('http://127.0.0.1:5001/v1/status').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  web:
    build:
      context: ../..
      dockerfile: docker/images/web/production.Dockerfile
    image: portfolio-web:production
    container_name: portfolio-web-prod
    init: true
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: "3000"
      HOSTNAME: "0.0.0.0"
      API_GATEWAY_URL: http://api:5001
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:5001}
      NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${NEXT_PUBLIC_SANITY_PROJECT_ID:-}
      NEXT_PUBLIC_SANITY_DATASET: ${NEXT_PUBLIC_SANITY_DATASET:-}
      NEXT_PUBLIC_SANITY_API_VERSION: ${NEXT_PUBLIC_SANITY_API_VERSION:-}
      SANITY_PROJECT_ID: ${SANITY_PROJECT_ID:-}
      SANITY_DATASET: ${SANITY_DATASET:-}
      SANITY_API_VERSION: ${SANITY_API_VERSION:-}
      SANITY_API_READ_TOKEN: ${SANITY_API_READ_TOKEN:-}
      SANITY_USE_CDN: ${SANITY_USE_CDN:-true}
      SANITY_WEBHOOK_SECRET: ${SANITY_WEBHOOK_SECRET:-}
      SANITY_STUDIO_PREVIEW_ORIGIN: ${SANITY_STUDIO_PREVIEW_ORIGIN:-}
      NEXT_TELEMETRY_DISABLED: "1"
    ports:
      - "${PROD_WEB_PORT:-3000}:3000"
    volumes:
      - web-next-cache:/app/.next/cache
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          node -e "fetch('http://127.0.0.1:3000/').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 45s

volumes:
  web-next-cache:
