#!/usr/bin/env sh
# Validate branch name before pushing
pnpm exec validate-branch-name

# Prevent pushing commits that are not GPG-verified locally.
zero_hash="0000000000000000000000000000000000000000"
has_invalid_signature=0

while read -r local_ref local_sha remote_ref remote_sha; do
  if [ -z "$local_ref" ]; then
    continue
  fi

  # Skip deleted refs.
  if [ "$local_sha" = "$zero_hash" ]; then
    continue
  fi

  if [ "$remote_sha" = "$zero_hash" ]; then
    range="$local_sha"
  else
    range="$remote_sha..$local_sha"
  fi

  invalid_commits="$(git log --format='%H %G?' "$range" | awk '$2 != "G" { print $1 " (" $2 ")" }')"

  if [ -n "$invalid_commits" ]; then
    echo "âŒ Push blocked: found unsigned/unverified commits for $local_ref -> $remote_ref"
    echo "$invalid_commits" | sed -n '1,20p'
    has_invalid_signature=1
  fi
done

if [ "$has_invalid_signature" -eq 1 ]; then
  echo "Sign and verify commits before pushing."
  exit 1
fi
